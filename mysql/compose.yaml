services:
  # Traefik Reverse Proxy Service
  proxy:
    image: traefik:3
    command: --providers.docker
    ports:
      - 80:80
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
  
  # app service
  app:
    build:
      context: .
      target: dev
      args:
        PYTHON_VERSION: ${PYTHON_VERSION:-3.13}
        DEV_UID: ${USERID:-1000} # Use host user ID for better file permissions
        DEV_GID: ${GROUPID:-1000} # Use host group ID
    command: ["tail", "-f", "/dev/null"]
    ports:
      - 3000:3000
    env_file:
      - .env
    # environment:
      # MYSQL_HOST: db
      # MYSQL_USER: root
      # MYSQL_PASSWORD: secret
      # MYSQL_DATABASE: ems
    volumes:
      - .:/app:rw # Mount project for live updates
      - dev-venv-ems-mysql:/app/.venv # Named volume for the virtual environment
    working_dir: /app
    develop:
      watch:
        - action: sync
          path: .
          target: /app
          ignore:
            - .git/
            - .venv/
            - __pycache__/
            - .dockerignore
            - .gitignore
            - Dockerfile
            - compose.yaml
            - README*.md
        - action: rebuild
          path: ./pyproject.toml
        - action: rebuild
          path: ./uv.lock
    labels:
      traefik.http.routers.backend.rule: Host(`localhost`)
      traefik.http.services.backend.loadbalancer.server.port: 3000
        
  ## MySQL database Service
  db:
    image: mysql:9
    working_dir: /app
    volumes:
      - ems-mysql-data:/var/lib/mysql
      - ./schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - ./queries.sql:/docker-entrypoint-initdb.d/02-queries.sql
      - ./schema.sql:/app/schema.sql
      - ./queries.sql:/app/queries.sql
    environment: 
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: ems
      # MYSQL_ALLOW_EMPTY_PASSWORD: yes
  
  # phpMyAdmin Service
  # This service provides a web interface for managing the MySQL database.
  phpmyadmin:
    image: phpmyadmin
    environment:
      PMA_HOST: db
      PMA_USER: root
      PMA_PASSWORD: secret
    labels:
      traefik.http.routers.phpmyadmin.rule: Host(`db.localhost`)
      traefik.http.services.phpmyadmin.loadbalancer.server.port: 80

# Define the named volume for the virtual environment
volumes:
  dev-venv-ems-mysql:
  ems-mysql-data: